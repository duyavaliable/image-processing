# á»¨ng Dá»¥ng Xá»­ LÃ½ áº¢nh - Computer Vision

á»¨ng dá»¥ng web xá»­ lÃ½ áº£nh toÃ n diá»‡n vá»›i giao diá»‡n thÃ¢n thiá»‡n, há»— trá»£ nhiá»u phÆ°Æ¡ng phÃ¡p biáº¿n Ä‘á»•i áº£nh, khá»­ nhiá»…u, vÃ  nháº­n diá»‡n Ä‘á»‘i tÆ°á»£ng.

## ğŸ“‹ Tá»•ng Quan

á»¨ng dá»¥ng cho phÃ©p ngÆ°á»i dÃ¹ng táº£i lÃªn áº£nh vÃ  Ã¡p dá»¥ng cÃ¡c ká»¹ thuáº­t xá»­ lÃ½ áº£nh khÃ¡c nhau thÃ´ng qua giao diá»‡n kÃ©o-tháº£ trá»±c quan. Backend xá»­ lÃ½ báº±ng Flask + OpenCV, frontend sá»­ dá»¥ng vanilla JavaScript.

## ğŸš€ CÃ i Äáº·t & Cháº¡y

### YÃªu Cáº§u
- Python 3.8+
- pip

### CÃ¡c BÆ°á»›c

1. **Clone repository vÃ  di chuyá»ƒn vÃ o thÆ° má»¥c:**
   ```bash
   cd computer-vision-mid-term
   ```

2. **Táº¡o mÃ´i trÆ°á»ng áº£o:**
   ```bash
   python -m venv .venv
   # Windows:
   .venv\Scripts\activate
   # macOS/Linux:
   source .venv/bin/activate
   ```

3. **CÃ i Ä‘áº·t dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

4. **Táº£i mÃ´ hÃ¬nh YOLO (cho nháº­n diá»‡n Ä‘á»‘i tÆ°á»£ng):**
   - Táº£i [YOLOv5s ONNX](https://github.com/ultralytics/yolov5/releases/download/v6.0/yolov5s.onnx)
   - Äáº·t vÃ o thÆ° má»¥c `models/yolov5s.onnx`

5. **Cháº¡y server:**
   ```bash
   python server.py
   ```

6. **Má»Ÿ trÃ¬nh duyá»‡t:**
   ```
   http://localhost:5500
   ```

## ğŸ“ Cáº¥u TrÃºc Dá»± Ãn

```
.
â”œâ”€â”€ index.html              # Giao diá»‡n chÃ­nh
â”œâ”€â”€ server.py               # Flask backend
â”œâ”€â”€ requirements.txt        # Python dependencies
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.js             # Logic frontend
â”‚   â””â”€â”€ styles.css         # Giao diá»‡n CSS
â””â”€â”€ models/
    â””â”€â”€ yolov5s.onnx       # MÃ´ hÃ¬nh YOLO (táº£i riÃªng)
```

## ğŸ¨ CÃ¡c Chá»©c NÄƒng

### 1. Biáº¿n Äá»•i CÆ°á»ng Äá»™ (Intensity Transformations)

#### **Grayscale 8-bit**
- Chuyá»ƒn áº£nh mÃ u sang áº£nh xÃ¡m
- CÃ´ng thá»©c: `Gray = 0.299Ã—R + 0.587Ã—G + 0.114Ã—B`
- **á»¨ng dá»¥ng:** Tiá»n xá»­ lÃ½ cho cÃ¡c thuáº­t toÃ¡n phÃ¢n tÃ­ch áº£nh

#### **Negative Images**
- Äáº£o ngÆ°á»£c giÃ¡ trá»‹ pixel: `output = 255 - input`
- **á»¨ng dá»¥ng:** TÄƒng cÆ°á»ng chi tiáº¿t vÃ¹ng tá»‘i, chá»¥p X-quang y táº¿

#### **Logarithmic Transformation**
- CÃ´ng thá»©c: `s = c Ã— log(1 + r)`
- **á»¨ng dá»¥ng:** Má»Ÿ rá»™ng vÃ¹ng tá»‘i, nÃ©n vÃ¹ng sÃ¡ng (áº£nh chá»¥p phÆ¡i sÃ¡ng kÃ©m)
- **Tham sá»‘:** `c` Ä‘iá»u chá»‰nh Ä‘á»™ máº¡nh (máº·c Ä‘á»‹nh: 2.0)

#### **Power-Law (Gamma Correction)**
- CÃ´ng thá»©c: `s = r^Î³`
- **Tham sá»‘:**
  - `Î³ < 1`: LÃ m sÃ¡ng áº£nh
  - `Î³ > 1`: LÃ m tá»‘i áº£nh
  - `Î³ = 1`: KhÃ´ng thay Ä‘á»•i
- **á»¨ng dá»¥ng:** Äiá»u chá»‰nh Ä‘á»™ sÃ¡ng mÃ n hÃ¬nh, sá»­a gamma camera
- **Äiá»u khiá»ƒn:** Nháº­p giÃ¡ trá»‹ gamma thá»§ cÃ´ng (0.1 - 10)

#### **Piecewise Linear (Contrast Stretch)**
- Ãnh xáº¡ phi tuyáº¿n theo 2 Ä‘iá»ƒm kiá»ƒm soÃ¡t `(r1,s1)` vÃ  `(r2,s2)`
- **á»¨ng dá»¥ng:** TÄƒng tÆ°Æ¡ng pháº£n vÃ¹ng quan tÃ¢m
- **Tham sá»‘:**
  - `r1, r2`: NgÆ°á»¡ng input (1-255)
  - `s1, s2`: GiÃ¡ trá»‹ output tÆ°Æ¡ng á»©ng (0-255)

#### **Thresholding (Binary)**
- PhÃ¢n ngÆ°á»¡ng áº£nh: `output = 255 náº¿u input > T, ngÆ°á»£c láº¡i 0`
- **Tham sá»‘:** NgÆ°á»¡ng `T` (0-255, máº·c Ä‘á»‹nh 128)
- **á»¨ng dá»¥ng:** PhÃ¢n Ä‘oáº¡n Ä‘á»‘i tÆ°á»£ng, nhá»‹ phÃ¢n hÃ³a áº£nh

### 2. Xá»­ LÃ½ Nhiá»…u (Denoising)

#### **PhÆ°Æ¡ng phÃ¡p khá»­ nhiá»…u thá»§ cÃ´ng (Manual Denoise)**

Cho phÃ©p ngÆ°á»i dÃ¹ng chá»n phÆ°Æ¡ng phÃ¡p phÃ¹ há»£p vá»›i loáº¡i nhiá»…u:

##### **Median Filter**
- **Nhiá»…u phÃ¹ há»£p:** Salt-and-Pepper (nhiá»…u muá»‘i tiÃªu)
- **Tham sá»‘:** Kernel size (3-31, láº»)
- **Æ¯u Ä‘iá»ƒm:** Báº£o toÃ n biÃªn, loáº¡i bá» hiá»‡u quáº£ nhiá»…u xung
- **á»¨ng dá»¥ng:** áº¢nh bá»‹ lá»—i truyá»n, nhiá»…u Ä‘iá»ƒm ngáº«u nhiÃªn

##### **Bilateral Filter**
- **Nhiá»…u phÃ¹ há»£p:** Gaussian (nhiá»…u cá»™ng)
- **Tham sá»‘:** 
  - `d`: ÄÆ°á»ng kÃ­nh vÃ¹ng lá»c (kernel size)
  - `sigma`: Tá»± Ä‘á»™ng = d Ã— 10
- **Æ¯u Ä‘iá»ƒm:** LÃ m mÆ°á»£t vÃ¹ng Ä‘á»“ng nháº¥t, giá»¯ biÃªn sáº¯c nÃ©t
- **á»¨ng dá»¥ng:** Nhiá»…u cáº£m biáº¿n, nhiá»…u nhiá»‡t

##### **Non-local Means (NLM)**
- **Nhiá»…u phÃ¹ há»£p:** Gaussian, nhiá»…u texture
- **Tham sá»‘:** `h` (cÆ°á»ng Ä‘á»™ lá»c) = kernel Ã— 2
- **Æ¯u Ä‘iá»ƒm:** Báº£o toÃ n texture, chi tiáº¿t cao
- **á»¨ng dá»¥ng:** áº¢nh cÃ³ nhiá»u texture láº·p láº¡i

##### **Lee Filter** *(Server-side implementation)*
- **Nhiá»…u phÃ¹ há»£p:** Speckle (nhiá»…u nhÃ¢n)
- **Tham sá»‘:** Window size (3-31)
- **CÃ´ng thá»©c:** Káº¿t há»£p trung bÃ¬nh cá»¥c bá»™ vÃ  variance
- **á»¨ng dá»¥ng:** áº¢nh SAR, radar, siÃªu Ã¢m

#### **PhÃ¢n TÃ­ch Histogram**

Server tá»± Ä‘á»™ng phÃ¢n tÃ­ch histogram vÃ  gá»£i Ã½ phÆ°Æ¡ng phÃ¡p:

- **`extreme_ratio`**: Tá»‰ lá»‡ pixel Ä‘en/tráº¯ng thuáº§n (`0` hoáº·c `255`)
  - `> 2%` â†’ Gá»£i Ã½ Median (Salt-and-Pepper)

- **`variance`**: Äá»™ phÃ¢n tÃ¡n pixel
  - `100 < variance < 2000` â†’ Gá»£i Ã½ Bilateral (Gaussian)

- **`cv` (Coefficient of Variation)**: `std / mean`
  - `> 0.28` â†’ Gá»£i Ã½ Lee (Speckle)

- **`suggested_method`**: PhÆ°Æ¡ng phÃ¡p Ä‘Æ°á»£c gá»£i Ã½ dá»±a trÃªn phÃ¢n tÃ­ch

**LÆ°u Ã½:** Histogram params Ä‘Æ°á»£c tráº£ vá» tá»« server nhÆ°ng **khÃ´ng hiá»ƒn thá»‹ trÃªn UI** Ä‘á»ƒ giao diá»‡n gá»n gÃ ng.

### 3. TÄƒng CÆ°á»ng áº¢nh (Enhancement)

#### **Histogram Equalization**
- CÃ¢n báº±ng histogram Ä‘á»ƒ tÄƒng tÆ°Æ¡ng pháº£n toÃ n cá»¥c
- **á»¨ng dá»¥ng:** áº¢nh cÃ³ Ä‘á»™ tÆ°Æ¡ng pháº£n tháº¥p, phÃ¢n bá»‘ cÆ°á»ng Ä‘á»™ khÃ´ng Ä‘á»u

#### **Sharpening (Laplacian)**
- TÄƒng cÆ°á»ng biÃªn báº±ng bá»™ lá»c Laplacian
- **CÃ´ng thá»©c:** `output = input - âˆ‡Â²input`
- **Há»— trá»£:** áº¢nh mÃ u (xá»­ lÃ½ tá»«ng kÃªnh) vÃ  áº£nh xÃ¡m
- **á»¨ng dá»¥ng:** LÃ m rÃµ biÃªn, chi tiáº¿t má»

### 4. Lá»c Táº§n Sá»‘ (Frequency Domain Filtering)

Ãp dá»¥ng DFT/FFT Ä‘á»ƒ lá»c trong miá»n táº§n sá»‘:

#### **Lowpass Filters (Lá»c thÃ´ng tháº¥p)**
- Loáº¡i bá» táº§n sá»‘ cao (nhiá»…u, chi tiáº¿t nhá»)
- **Loáº¡i:**
  - **Ideal:** Cáº¯t cá»©ng táº¡i táº§n sá»‘ `D0`
  - **Butterworth:** Chuyá»ƒn tiáº¿p mÆ°á»£t (order `n`)
  - **Gaussian:** Chuyá»ƒn tiáº¿p mÆ°á»£t nháº¥t

#### **Highpass Filters (Lá»c thÃ´ng cao)**
- TÄƒng cÆ°á»ng biÃªn, loáº¡i bá» background
- **Loáº¡i:** TÆ°Æ¡ng tá»± lowpass

**Tham sá»‘:**
- `Cutoff (D0)`: Táº§n sá»‘ cáº¯t (5-200, máº·c Ä‘á»‹nh 30)
- `Order (n)`: Báº­c Butterworth (1-10, máº·c Ä‘á»‹nh 2)

**á»¨ng dá»¥ng:**
- Lowpass: LÃ m mÆ°á»£t, giáº£m nhiá»…u
- Highpass: PhÃ¡t hiá»‡n biÃªn, tÄƒng cÆ°á»ng chi tiáº¿t

### 5. KhÃ´i Phá»¥c áº¢nh (Restoration)

#### **Wiener Filter** *(Approximation)*
- Lá»c tá»‘i Æ°u káº¿t há»£p thÃ´ng tin áº£nh vÃ  nhiá»…u
- **Implementation:** Sá»­ dá»¥ng bilateral filter lÃ m xáº¥p xá»‰
- **Tham sá»‘:** `noise_var` (variance cá»§a nhiá»…u, máº·c Ä‘á»‹nh 100)
- **á»¨ng dá»¥ng:** Deblur, khá»­ nhiá»…u khi biáº¿t PSF

### 6. Nháº­n Diá»‡n Äá»‘i TÆ°á»£ng (Object Detection)

#### **YOLO (You Only Look Once)**
- MÃ´ hÃ¬nh: YOLOv5s ONNX
- **Tham sá»‘:**
  - `conf_thresh`: NgÆ°á»¡ng confidence (máº·c Ä‘á»‹nh 0.25)
  - `iou_thresh`: NgÆ°á»¡ng IoU cho NMS (máº·c Ä‘á»‹nh 0.45)
  - `inp_size`: KÃ­ch thÆ°á»›c input (máº·c Ä‘á»‹nh 640)

#### **CÃ¡c Lá»›p Há»— Trá»£ (80 lá»›p COCO)**
- Person, bicycle, car, motorcycle, airplane, bus, train, truck, boat...
- Dog, cat, bird, horse, sheep, cow, elephant, bear, zebra, giraffe...
- Bottle, cup, fork, knife, spoon, bowl, banana, apple, sandwich...
- Chair, couch, bed, dining table, toilet, tv, laptop, mouse, keyboard...
- *(Xem full danh sÃ¡ch 80 lá»›p trong [`server.py`](server.py))*

#### **Output**
- **HÃ¬nh áº£nh:** Bounding boxes + labels + confidence scores
- **Message:** `Detected {N} objects`
- **Params (khÃ´ng hiá»ƒn thá»‹ trÃªn UI):**
  ```json
  {
    "detected_objects": [
      {"label": "person", "confidence": 0.92, "bbox": [x, y, w, h]},
      ...
    ],
    "total_detected": N,
    "backend": "yolo_detect"
  }
  ```

## ğŸ® CÃ¡ch Sá»­ Dá»¥ng

### Giao Diá»‡n ChÃ­nh

1. **Táº£i áº£nh lÃªn:**
   - KÃ©o & tháº£ áº£nh vÃ o vÃ¹ng "drop area"
   - Hoáº·c click **"Táº£i áº£nh lÃªn"** Ä‘á»ƒ chá»n file

2. **Chá»n cháº¿ Ä‘á»™ xá»­ lÃ½:**
   - Dropdown menu hiá»ƒn thá»‹ táº¥t cáº£ cÃ¡c cháº¿ Ä‘á»™
   - CÃ¡c Ä‘iá»u khiá»ƒn tÆ°Æ¡ng á»©ng sáº½ hiá»‡n/áº©n tá»± Ä‘á»™ng

3. **Äiá»u chá»‰nh tham sá»‘:**
   - Gamma: Nháº­p giÃ¡ trá»‹ â†’ Enter Ä‘á»ƒ Ã¡p dá»¥ng
   - Piecewise: Nháº­p r1, s1, r2, s2 â†’ Enter
   - Denoise: Chá»n method + kernel size
   - Sharpening: Chá»‰ cÃ³ Laplacian (tá»± Ä‘á»™ng)
   - Frequency Filter: Chá»n type + cutoff + order
   - Threshold: Nháº­p T â†’ Enter

4. **Xem káº¿t quáº£:**
   - áº¢nh preview hiá»ƒn thá»‹ ngay láº­p tá»©c
   - Message phÃ­a dÆ°á»›i mÃ´ táº£ káº¿t quáº£ xá»­ lÃ½

### Keyboard Shortcuts

- **Enter** trong cÃ¡c input field:
  - Gamma, Piecewise params: Ãp dá»¥ng ngay
  - Denoise kernel: Ãp dá»¥ng ngay
  - Frequency filter params: Ãp dá»¥ng ngay
  - Threshold T: Ãp dá»¥ng ngay

- **Debounce** cho Denoise kernel input: 800ms (tá»± Ä‘á»™ng re-process khi ngá»«ng nháº­p)

### Format áº¢nh Há»— Trá»£

- **JPEG/JPG**: Full support (server decode)
- **PNG**: Full support
- **TIFF**: Server-side processing only (browser khÃ´ng render TIFF trá»±c tiáº¿p)
- **Max size:** 8MB

## ğŸ”§ Chi Tiáº¿t Ká»¹ Thuáº­t

### Backend (Flask + OpenCV)

#### **Robust Image Decoding**
- [`ensure_gray_uint8_from_bytes()`](server.py): Decode áº£nh tá»« bytes
- Há»— trá»£: RGBA, 16-bit, float, TIFF
- Fallback qua nhiá»u `cv2.IMREAD_*` flags

#### **Noise Detection Heuristics**
- [`detect_noise_type()`](server.py): PhÃ¢n tÃ­ch loáº¡i nhiá»…u
- **Primary:** Frequency domain (FFT peaks, energy ratio)
- **Fallback:** Histogram features (extreme_ratio, variance, CV)

#### **Adaptive Filtering**
- [`adaptive_median_filter()`](server.py): TÄƒng window size Ä‘á»™ng
- [`lee_filter()`](server.py): Speckle noise reduction

#### **Frequency Domain Processing**
- [`notch_filter_auto()`](server.py): Loáº¡i bá» periodic noise
- Percentile clipping (p01-p99) Ä‘á»ƒ trÃ¡nh outliers

### Frontend (Vanilla JavaScript)

#### **Event-Driven Architecture**
- Mode change â†’ `updateControlsVisibility()` â†’ re-process
- Input events â†’ debounced re-processing
- File drop â†’ `handleFile()` â†’ upload â†’ display

#### **Client-Side Processing** *(optional fallback)*
- [`toGray8DataURL()`](src/app.js): Grayscale conversion
- [`toLogDataURL()`](src/app.js): Log transform
- [`toMedianDataURL()`](src/app.js): Median filter (slow, demo only)

**Server-first Strategy:**
- Háº§u háº¿t processing trÃªn server (OpenCV máº¡nh hÆ¡n)
- Client chá»‰ xá»­ lÃ½ preview nhanh (náº¿u áº£nh nhá»)

#### **Preview Management**
- [`showInputPreview()`](src/app.js): Preview áº£nh gá»‘c
  - TIFF: Upload server Ä‘á»ƒ convert â†’ preview
  - Other: Object URL hoáº·c fallback server
- [`showPreview()`](src/app.js): Preview áº£nh káº¿t quáº£

## ğŸ› Debug & Logging

### Server Logs
```python
print(f"[mode] processing image: {mode}, extras: {extras}")
```

### Client Logs
```javascript
console.log('[handleFile] mode:', mode, 'file:', file.name);
console.debug('[uploadFileToServer] response:', resp);
```

### Common Issues

#### **1. TIFF khÃ´ng hiá»ƒn thá»‹ preview**
- âœ… Server xá»­ lÃ½ TIFF â†’ convert sang PNG base64
- âš ï¸ Browser khÃ´ng render TIFF trá»±c tiáº¿p

#### **2. Params khÃ´ng hiá»ƒn thá»‹ cho `denoise_manual` / `count_objects`**
- âœ… Intentional: UI chá»‰ hiá»ƒn thá»‹ message ngáº¯n gá»n
- ğŸ” Xem params trong console: `console.debug('[handleFile] server response:', resp)`

#### **3. JPEG decode error**
- âœ… Fallback: [`ensure_gray_uint8_from_bytes()`](server.py) thá»­ nhiá»u flags
- âš ï¸ áº¢nh JPEG corrupt/metadata phá»©c táº¡p cÃ³ thá»ƒ fail

#### **4. Frequency filter output tá»‘i/sÃ¡ng báº¥t thÆ°á»ng**
- âœ… Normalize: `(img - min) / (max - min) Ã— 255`
- âš ï¸ Kiá»ƒm tra `cutoff` vÃ  `order` cÃ³ há»£p lÃ½ khÃ´ng

## ğŸ“š TÃ i Liá»‡u Tham Kháº£o

### LÃ½ Thuyáº¿t
- **Gonzalez & Woods:** *Digital Image Processing* (3rd Ed.)
  - Chapter 3: Intensity Transformations
  - Chapter 5: Image Restoration
  - Chapter 4: Filtering in Frequency Domain

### Thuáº­t ToÃ¡n
- **Median Filter:** Tukey, 1977
- **Bilateral Filter:** Tomasi & Manduchi, 1998
- **Non-local Means:** Buades et al., 2005
- **Lee Filter:** Lee, 1980 (for speckle noise)
- **YOLOv5:** Ultralytics, 2020

### OpenCV Documentation
- [cv2.medianBlur](https://docs.opencv.org/4.x/d4/d86/group__imgproc__filter.html#ga564869aa33e58769b4469101aac458f9)
- [cv2.bilateralFilter](https://docs.opencv.org/4.x/d4/d86/group__imgproc__filter.html#ga9d7064d478c95d60003cf839430689ed)
- [cv2.fastNlMeansDenoising](https://docs.opencv.org/4.x/d1/d79/group__photo__denoise.html#ga4c6b0031f56ea3f98f768881279ffe93)
- [cv2.dft / cv2.idft](https://docs.opencv.org/4.x/d2/de8/group__core__array.html#gadd6cf9baf2b8b704a11b5f04aaf4f39d)

## ğŸ¤ ÄÃ³ng GÃ³p

Náº¿u báº¡n muá»‘n thÃªm tÃ­nh nÄƒng:
1. Fork repo
2. Táº¡o feature branch: `git checkout -b feature/AmazingFeature`
3. Commit: `git commit -m 'Add some AmazingFeature'`
4. Push: `git push origin feature/AmazingFeature`
5. Táº¡o Pull Request

## ğŸ“ License

MIT License - Xem [LICENSE](LICENSE) Ä‘á»ƒ biáº¿t chi tiáº¿t.

## ğŸ‘¨â€ğŸ’» TÃ¡c Giáº£

**[TÃªn cá»§a báº¡n]**
- Email: [email@example.com]
- GitHub: [@yourusername](https://github.com/yourusername)

---

**Note:** README nÃ y Ä‘Æ°á»£c táº¡o dá»±a trÃªn cáº¥u trÃºc thá»±c táº¿ cá»§a dá»± Ã¡n. Má»i tÃ­nh nÄƒng Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm tra vÃ  hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh vá»›i Python 3.8+ vÃ  cÃ¡c dependencies trong [`requirements.txt`](requirements.txt).